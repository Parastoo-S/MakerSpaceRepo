<section id ="page-contents" >

<div>Trainer: <%= User.find(@current_training_session.user_id).name%></div><br>

<div>Training Type: <%= @current_training_session.training.name %>
    <br>
    <%= form_for staff_training_session_path(@current_training_session), method: 'PATCH', action: 'update' do |f| %>
      <% label_tag 'changed_params[training_id]' %>
      <%= select_tag 'changed_params[training_id]', options_from_collection_for_select(Training.all, 'id', 'name'), prompt: 'change training' %><br>
</div><br>


  <table class="training-session-users-table">
      Users in this training session
      <tr>
        <th>Drop</th>
        <th>Username</th>
        <th>Last Signed In</th>
        <th>Location</th>
        <th>Certification</th>
      </tr>

    <% @current_training_session.users.each do |user| %>
      <tr class="drop-rows">

        <td class="drop-checkbox-cell" onclick="check_users(this)">
          <input type="checkbox" class="drop-user-checkbox"></input>
        </td>

        <td class="drop-username-cell"><%=
          link_to(content_tag(:drop_username, user.username), user_url(user.username))
        %></td>

        <td class="signed_in-cell" style="horizontal-alginment:center;"><%=
          if user.lab_sessions.present?
            singout_time = user.lab_sessions.last.sign_out_time
            singout_time.strftime("%B %d, %Y")
          end
        %></td>

        <td class="location-cell"><%=
          user.location
        %></td>

        <td class="certifications-cell"><%
          if user.certifications.first.present?
            user.certifications.each do |certification|
            %>
            <div
             class="cert-name"
             style="display:inline" >
             <div class="cert-holder" style="display:inline">
              <%= certification.training %> |
              <div id="cert-details" style="display:inline">
                <%= certification.training %> <br>
                <%= certification.trainer %> <br>
                <%= certification.updated_at.strftime("%B %d, %Y")  %>
              </div>
            </div>
          </div>
          <%
            end
          end
          %>
        </td>

      </tr>
    <% end %>
    </table>
    <br>
    <%= submit_tag "Certify", class: 'certify-button' %>

    <br>

    <table>
      Other Users
      <tr>
        <th>Add</th>
        <th>Username</th>
        <th>Last Signed In</th>
        <th>Location</th>
        <th>Certification</th>
      </tr>

    <% User.all.each do |user| %>
      <% unless @current_training_session.users.include?(user) %>
      <tr class="add-rows">

          <td class="add-checkbox-cell">
            <input type="checkbox" class="add-user-checkbox" onclick="check_users(this)"></input>
          </td>

          <td class="add-username-cell">
            <%= link_to(content_tag(:add_username, user.username), user_url(user.username)) %>
          </td>

          <td class="signed_in-cell" style="horizontal-alginment:center;">
            <%= if user.lab_sessions.present?
                  singout_time = user.lab_sessions.last.sign_out_time
                  singout_time.strftime("%B %d, %Y")
                end %>
          </td>

          <td class="location-cell">
            <%= user.location %></td>

          <td class="certifications-cell">
          <% user.certifications.each do |certification| %>
              <div
               class="cert-name"
               style="display:inline" >
               <div class="cert-holder" style="display:inline">
                <%= certification.training %> |
                <div id="cert-details" style="display:inline">
                  <%= certification.training %> <br>
                  <%= certification.trainer %> <br>
                  <%= certification.updated_at.strftime("%B %d, %Y")  %>
                </div>
              </div>
            </div>
          <% end %>
        </td>
      </tr>
      <% end %>
    <% end %>
    </table>

    <br>
    <input type="hidden", name="users"/>
    <%= submit_tag "Update", class: 'save-button' %>
  <% end %>


  <script>
    function check_users(){

      var users = document.getElementsByTagName("drop_username");
      var training_session_users = [];
      for(var i=0; i<users.length; i++){
        training_session_users.push(users[i].innerHTML);
      }

      var drop_check_boxes = document.getElementsByClassName('drop-user-checkbox');
      var drop_usernames = document.getElementsByTagName('drop_username');
       for(var i=0; i<drop_check_boxes.length;i++){
         if(drop_check_boxes[i].checked){
           if(training_session_users.indexOf(drop_usernames[i].innerHTML) > -1){
             training_session_users.splice(training_session_users.indexOf(drop_usernames[i].innerHTML), 1);
             document.getElementsByClassName('drop-rows')[i].style="background-color:#B04A45";
           }
         }else{
           document.getElementsByClassName('drop-rows')[i].style="background-color:#f0f5f5";
         }
       }

       var add_check_boxes = document.getElementsByClassName('add-user-checkbox');
       var add_usernames = document.getElementsByTagName('add_username');
        for(var i=0; i<add_check_boxes.length;i++){
          if(add_check_boxes[i].checked){
            training_session_users.push(add_usernames[i].innerHTML);
            document.getElementsByClassName('add-rows')[i].style="background-color:#A9D86B";
          }else{
            document.getElementsByClassName('add-rows')[i].style="background-color:#f0f5f5";
          }
        }
        console.log(training_session_users);
       document.getElementsByName("users")[0].value = JSON.stringify(training_session_users);
    }
  </script>

</section>
